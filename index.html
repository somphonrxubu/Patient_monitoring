<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>รายงานบริการกลุ่มเป้าหมายเร่งรัด โรงพยาบาลกุสุมาลย์</title>
    
    <!-- Google Fonts: Kanit Only -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
      /* --- Public Health Design System --- */
      :root {
        /* Brand Colors: MOPH / Medical Tone */
        --brand-primary: #007c68;     /* MOPH Green */
        --brand-secondary: #005a4b;   /* Darker Green */
        --brand-accent: #eab308;      /* Gold/Yellow for highlights */
        
        /* Functional Colors */
        --color-success: #15803d;     /* Green 700 */
        --color-bg-success: #dcfce7;  /* Green 100 */
        --color-info: #0369a1;        /* Sky 700 */
        --color-bg-info: #e0f2fe;     /* Sky 100 */
        --color-warning: #b45309;     /* Amber 700 */
        --color-bg-warning: #fef3c7;  /* Amber 100 */
        --color-danger: #b91c1c;      /* Red 700 */
        --color-bg-danger: #fee2e2;   /* Red 100 */
        
        /* Neutrals */
        --bg-body: #f4f6f8;           /* Light Gray Background */
        --bg-card: #ffffff;
        --text-head: #111827;         /* Nearly Black */
        --text-body: #374151;         /* Dark Gray */
        --text-muted: #6b7280;        /* Medium Gray */
        --border-color: #e5e7eb;
        
        /* Gradients */
        --grad-primary: linear-gradient(135deg, #00947a 0%, #006d5b 100%);
        --grad-bar-green: linear-gradient(90deg, #34d399 0%, #059669 100%);
        --grad-bar-blue: linear-gradient(90deg, #60a5fa 0%, #2563eb 100%);
        --grad-bar-purple: linear-gradient(90deg, #c084fc 0%, #9333ea 100%);
        
        /* Shadows */
        --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
        --shadow-card: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
      }

      * { box-sizing: border-box; }
      
      body { 
        font-family: 'Kanit', sans-serif; /* ใช้ฟอนต์ Kanit ทั้งหมด */
        background-color: var(--bg-body); 
        margin: 0; 
        padding: 16px;
        color: var(--text-body);
        line-height: 1.6;
      }

      @media (min-width: 640px) { body { padding: 24px; } }

      /* Layout */
      .container { 
        width: 100%; max-width: 1400px; margin: 0 auto; 
        display: flex; flex-direction: column; gap: 20px; 
      }
      
      /* Grid System */
      .grid-cols-2 {
        display: grid; grid-template-columns: 1fr; gap: 20px;
      }
      @media (min-width: 1024px) { 
        .grid-cols-2 { grid-template-columns: 1fr 1fr; } /* 1:1 Ratio on desktop */
      }
      
      /* Flex Utilities */
      .flex-col-stack {
        display: flex; flex-direction: column; gap: 20px;
      }

      /* --- Header --- */
      .header-card {
        background: var(--grad-primary);
        color: white;
        border-radius: 12px;
        padding: 24px;
        position: relative;
        box-shadow: 0 10px 15px -3px rgba(0, 124, 104, 0.3);
        overflow: hidden;
        border-bottom: 4px solid var(--brand-accent);
      }
      
      .header-card::before {
        content: ""; position: absolute; top: -50px; right: -50px;
        width: 200px; height: 200px;
        background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
        border-radius: 50%; pointer-events: none;
      }
      .header-card::after {
        content: ""; position: absolute; bottom: -80px; left: -20px;
        width: 250px; height: 250px;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        border-radius: 50%; pointer-events: none;
      }

      .header-content { position: relative; z-index: 10; text-align: center; }
      
      .app-title { 
        font-size: 24px; font-weight: 600; margin: 0; 
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .app-subtitle { 
        font-size: 18px; font-weight: 500; margin-top: 4px; opacity: 0.95; 
      }
      
      @media (min-width: 768px) {
        .app-title { font-size: 32px; }
        .app-subtitle { font-size: 22px; }
      }

      .update-badge {
        display: inline-flex; align-items: center; gap: 8px;
        background: rgba(0,0,0,0.2);
        padding: 6px 16px; border-radius: 20px;
        margin-top: 4px; 
        font-size: 14px;
        border: 1px solid rgba(255,255,255,0.2);
      }

      .refresh-icon-btn {
        background: none; border: none; color: white; cursor: pointer; padding: 0;
        display: flex; transition: transform 0.3s; opacity: 0.8;
      }
      .refresh-icon-btn:hover { opacity: 1; transform: rotate(180deg); }
      .spin { animation: spin 1s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }

      /* --- Cards & Panels --- */
      .card-panel {
        background: var(--bg-card);
        border-radius: 12px;
        box-shadow: var(--shadow-card);
        border: 1px solid var(--border-color);
        overflow: hidden;
        display: flex; flex-direction: column;
        height: 100%;
      }
      
      .card-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex; align-items: center; gap: 12px;
        background: #fcfcfc;
      }
      
      /* Card Accents */
      .accent-blue { border-top: 4px solid var(--color-info); }
      .accent-green { border-top: 4px solid var(--color-success); }
      .accent-orange { border-top: 4px solid var(--color-warning); }

      .icon-wrapper {
        width: 40px; height: 40px; border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
      }
      .bg-icon-blue { background: var(--color-bg-info); color: var(--color-info); }
      .bg-icon-green { background: var(--color-bg-success); color: var(--color-success); }
      .bg-icon-orange { background: var(--color-bg-warning); color: var(--color-warning); }
      .bg-icon-red { background: var(--color-bg-danger); color: var(--color-danger); }

      .card-label {
        font-size: 18px; font-weight: 600; color: var(--text-head); line-height: 1.2;
      }
      .card-desc { font-size: 13px; color: var(--text-muted); }

      .card-body { padding: 20px; flex: 1; }

      /* Stat Blocks */
      .stat-container {
        display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;
      }
      .stat-block {
        background: var(--bg-body); border-radius: 10px; padding: 12px;
        text-align: center; border: 1px solid var(--border-color);
      }
      .stat-title { font-size: 13px; color: var(--text-muted); margin-bottom: 6px; font-weight: 500; }
      
      .number-display-lg { font-size: 56px; font-weight: 600; color: var(--text-head); line-height: 1; }
      .number-display-md { font-size: 40px; font-weight: 600; color: var(--color-danger); line-height: 1; }
      
      @media (min-width: 1280px) {
        .number-display-lg { font-size: 72px; }
        .number-display-md { font-size: 56px; }
      }
      
      .unit-text { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

      /* Split Stat (Today) - Modified for Full Height Divider */
      .split-row { 
        display: flex; 
        align-items: stretch; 
        justify-content: center; 
        gap: 16px; 
      }
      .split-col { 
        text-align: center; 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        justify-content: space-between; 
      }
      .split-line { 
        width: 1px; 
        background: #d1d5db; 
        margin: 4px 0; 
      }
      .split-head { font-size: 12px; color: var(--text-muted); margin-bottom: 2px; }

      /* Goal Section */
      .goal-section {
        margin-top: 12px; padding-top: 12px; border-top: 1px dashed #d1d5db;
        font-size: 13px; color: var(--text-muted); text-align: center;
      }
      .goal-val { font-weight: 600; font-size: 15px; display: block; margin-top: 4px; }

      /* Occupancy Bar Styling */
      .occupancy-box {
        margin-top: 16px; padding-top: 16px;
        border-top: none; 
        background: transparent;
      }
      .occ-label { font-size: 14px; font-weight: 600; color: var(--text-head); display: flex; justify-content: space-between; margin-bottom: 12px; }
      
      .bar-item { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
      .bar-name { width: 45px; font-size: 12px; font-weight: 600; color: var(--text-muted); }
      
      .progress-bg {
        flex: 1; height: 12px; background: #e5e7eb; border-radius: 6px; position: relative;
      }
      .progress-fg { height: 100%; border-radius: 6px; transition: width 1s ease; }
      .grad-today { background: var(--grad-bar-green); }
      .grad-month { background: var(--grad-bar-blue); }
      .grad-year { background: var(--grad-bar-purple); }

      /* Target Marker */
      .target-marker {
        position: absolute; top: -3px; bottom: -3px; width: 2px; background: var(--color-danger); z-index: 5;
        left: 80%;
      }
      .target-text {
        position: absolute; top: -16px; left: 50%; transform: translateX(-50%);
        font-size: 10px; font-weight: 700; color: var(--color-danger); 
        background: #fff; padding: 0 4px; border-radius: 2px;
      }
      
      .bar-percent { width: 55px; text-align: right; font-weight: 700; font-size: 14px; font-family: 'Kanit', sans-serif; }

      /* Table Design */
      .table-clean { width: 100%; border-collapse: collapse; font-size: 14px; }
      .table-clean th { 
        text-align: center; /* Center header */
        padding: 6px 12px; 
        background: #f9fafb; color: var(--text-muted); font-weight: 600;
        border-bottom: 2px solid var(--border-color);
        font-size: 14px; 
      }
      .table-clean th:first-child { text-align: left; padding-left: 12px; }

      .table-clean td { 
        padding: 6px 12px; 
        border-bottom: 1px solid #f3f4f6; 
        vertical-align: middle; color: var(--text-body);
        font-size: 14px; 
      }
      .table-clean tr:last-child td { border-bottom: none; }
      
      /* Standardize Number Cells */
      .td-center { text-align: center; }
      .td-num { 
        font-weight: 600; 
        font-size: 14px !important; 
        color: var(--text-head); text-align: center; 
        font-family: 'Kanit', sans-serif;
      }
      .td-total { 
        font-weight: 800; 
        font-size: 14px !important; 
        color: var(--color-danger); text-align: center; 
        font-family: 'Kanit', sans-serif;
      }
      
      /* Change Badges */
      .badge-change {
        display: inline-block; padding: 0; border-radius: 0;
        font-size: 14px !important; font-weight: 600; 
        background-color: transparent !important;
      }
      .badge-pos { color: #15803d; } 
      .badge-neg { color: #b91c1c; } 
      .badge-neu { color: #6b7280; } 
      
      .change-cell { text-align: center; font-weight: 600; font-size: 14px !important; }
      .change-cell-total { text-align: center; font-weight: 800; font-size: 14px !important; }

      @media (min-width: 1024px) {
        .custom-table th { font-size: 14px; }
        .custom-table td { font-size: 14px; }
        .td-num { font-size: 14px !important; }
        .td-total { font-size: 14px !important; }
      }

      /* Service List */
      .service-list-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: 16px; border: 1px solid var(--border-color);
        border-radius: 12px; margin-bottom: 12px;
        background: white; transition: all 0.2s;
      }
      .service-list-item:hover { border-color: #cbd5e1; box-shadow: var(--shadow-sm); }
      
      .svc-icon {
        width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
        background: var(--color-bg-warning); color: var(--color-warning); margin-right: 16px;
      }
      .svc-val { font-size: 24px; font-weight: 600; color: var(--color-danger); }

      /* Footer */
      .footer-section {
        text-align: center; 
        padding-top: 0; 
        border-top: none; 
        color: var(--text-muted); 
        font-size: 13px; 
        font-weight: 300; 
        margin-top: 0; 
        padding-bottom: 20px; 
      }
      
      .error-alert {
        background: #fef2f2; border: 1px solid #fecaca; color: #991b1b;
        padding: 12px; border-radius: 8px; text-align: center; margin-top: 16px; display: none;
      }

      /* Helpers */
      .text-red { color: var(--color-danger); }
      .text-green { color: var(--color-success); }
      .text-blue { color: var(--color-info); }
      .text-red-dark { color: #b91c1c; font-weight: 700; } 
      .text-green-dark { color: #15803d; font-weight: 700; } 
    </style>
  </head>
  <body>

    <div class="container">
      
      <!-- Header -->
      <div class="header-card">
        <div class="header-content">
          <h1 class="app-title">รายงานบริการกลุ่มเป้าหมายเร่งรัด</h1>
          <h2 class="app-subtitle">โรงพยาบาลกุสุมาลย์ จังหวัดสกลนคร ปีงบประมาณ พ.ศ. 2569</h2>
          
          <div class="update-badge">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            <span id="report_date">กำลังโหลด...</span>
            <button id="refresh_btn" class="refresh-icon-btn" onclick="fetchData(false)" title="รีเฟรชข้อมูล">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
            </button>
          </div>
        </div>
        <div id="error_box" class="error-alert"></div>
      </div>

      <!-- Main Stacked Layout -->
      <div class="flex-col-stack">
        
        <!-- Row 1: Wards (2 Columns) -->
        <div class="grid-cols-2">
            
            <!-- General Ward -->
            <div class="card-panel accent-blue">
              <div class="card-header" style="border-bottom: none;">
                <div class="icon-wrapper bg-icon-blue">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                </div>
                <div>
                  <div class="card-label">หอผู้ป่วยสามัญ</div>
                  <div class="card-desc">จำนวนผู้ป่วยที่เข้ารับการ Admit</div>
                </div>
              </div>
              <div class="card-body">
                <div class="stat-container">
                  <!-- Today -->
                  <div class="stat-block">
                    <div class="stat-title" style="color:var(--color-info);">รายใหม่วันนี้</div>
                    <div class="split-row">
                      <div class="split-col">
                        <div class="split-head">สามัญ</div>
                        <div class="number-display-lg count-up" id="ward_general_today">0</div>
                        <div class="unit-text">ราย</div>
                      </div>
                      <div class="split-line"></div>
                      <div class="split-col">
                        <div class="split-head">ผักหวาน</div>
                        <div class="number-display-lg count-up" id="ward_pakwan_today">0</div>
                        <div class="unit-text">ราย</div>
                      </div>
                    </div>
                  </div>
                  <!-- Accum -->
                  <div class="stat-block">
                    <div class="stat-title">สะสมเดือนนี้</div>
                    <div class="number-display-md count-up" id="ward_general_total">0</div>
                    <div class="unit-text">ราย</div>
                    <div class="goal-section">
                      <div>เป้าหมาย 360 ราย</div>
                      <div class="goal-val text-blue">คิดเป็น <span id="ward_general_percent">0.0</span>%</div>
                    </div>
                  </div>
                </div>

                <!-- Occupancy General -->
                <div class="occupancy-box">
                  <div class="occ-label">
                    <span>อัตราครองเตียงตึกสามัญ</span>
                    <span style="font-weight:400; color:var(--text-muted); font-size:12px;">เตียงจริง 36 เตียง</span>
                  </div>
                  <!-- Bars -->
                  <div class="bar-item">
                    <div class="bar-name">วันนี้</div>
                    <div class="progress-bg">
                      <div class="target-marker" style="left:80%"><div class="target-text">80%</div></div>
                      <div class="progress-fg grad-today" id="bar_gen_today"></div>
                    </div>
                    <div class="bar-percent text-green"><span id="txt_gen_today">0</span>%</div>
                  </div>
                  <div class="bar-item">
                    <div class="bar-name">เดือนนี้</div>
                    <div class="progress-bg">
                      <div class="target-marker" style="left:80%"></div>
                      <div class="progress-fg grad-month" id="bar_gen_accum"></div>
                    </div>
                    <div class="bar-percent text-blue"><span id="txt_gen_accum">0</span>%</div>
                  </div>
                  <div class="bar-item" style="margin-bottom:0;">
                    <div class="bar-name">ปีงบนี้</div>
                    <div class="progress-bg">
                      <div class="target-marker" style="left:80%"></div>
                      <div class="progress-fg grad-year" id="bar_gen_fiscal"></div>
                    </div>
                    <div class="bar-percent" style="color:#9333ea;"><span id="txt_gen_fiscal">0</span>%</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Special Ward -->
            <div class="card-panel accent-green">
              <div class="card-header" style="border-bottom: none;">
                <div class="icon-wrapper bg-icon-green">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></svg>
                </div>
                <div>
                  <div class="card-label">หอผู้ป่วยปุญโญภาส</div>
                  <div class="card-desc">จำนวนผู้ป่วยที่เข้ารับการ Admit</div>
                </div>
              </div>
              <div class="card-body">
                <div class="stat-container">
                  <!-- Today -->
                  <div class="stat-block">
                    <div class="stat-title" style="color:var(--color-success);">รายใหม่วันนี้</div>
                    <div class="number-display-lg count-up" id="ward_special_today">0</div>
                    <div class="unit-text">ราย</div>
                  </div>
                  <!-- Accum -->
                  <div class="stat-block">
                    <div class="stat-title">สะสมเดือนนี้</div>
                    <div class="number-display-md count-up" id="ward_special_total">0</div>
                    <div class="unit-text">ราย</div>
                    <div class="goal-section">
                      <div>เป้าหมาย 60 ราย</div>
                      <div class="goal-val text-green">คิดเป็น <span id="ward_special_percent">0.0</span>%</div>
                    </div>
                  </div>
                </div>

                <!-- Occupancy Special -->
                <div class="occupancy-box">
                  <div class="occ-label">
                    <span>อัตราครองเตียงตึกปุญโญภาส</span>
                    <span style="font-weight:400; color:var(--text-muted); font-size:12px;">เตียงจริง 6 เตียง</span>
                  </div>
                  <!-- Bars -->
                  <div class="bar-item">
                    <div class="bar-name">วันนี้</div>
                    <div class="progress-bg">
                      <div class="target-marker" style="left:80%"><div class="target-text">80%</div></div>
                      <div class="progress-fg grad-today" id="bar_spec_today"></div>
                    </div>
                    <div class="bar-percent text-green"><span id="txt_spec_today">0</span>%</div>
                  </div>
                  <div class="bar-item">
                    <div class="bar-name">เดือนนี้</div>
                    <div class="progress-bg">
                      <div class="target-marker" style="left:80%"></div>
                      <div class="progress-fg grad-month" id="bar_spec_accum"></div>
                    </div>
                    <div class="bar-percent text-blue"><span id="txt_spec_accum">0</span>%</div>
                  </div>
                  <div class="bar-item" style="margin-bottom:0;">
                    <div class="bar-name">ปีงบนี้</div>
                    <div class="progress-bg">
                      <div class="target-marker" style="left:80%"></div>
                      <div class="progress-fg grad-year" id="bar_spec_fiscal"></div>
                    </div>
                    <div class="bar-percent" style="color:#9333ea;"><span id="txt_spec_fiscal">0</span>%</div>
                  </div>
                </div>
              </div>
            </div>

        </div>

        <!-- Row 2: Total Occupancy (Full Width) -->
        <div class="card-panel accent-blue" style="padding:20px;">
             <!-- เพิ่ม Header พร้อม Icon -->
             <div class="card-header" style="border-bottom: none; padding: 0 0 16px 0; background: transparent;">
                <div class="icon-wrapper bg-icon-blue">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                </div>
                <div>
                   <div class="card-label">อัตราครองเตียงรวม</div>
                   <div class="card-desc">ตึกสามัญ + ตึกปุญโญภาส รวม 42 เตียง</div>
                </div>
             </div>
             
             <div style="display:flex; flex-direction:column; gap:12px;">
                <div class="bar-item">
                    <div class="bar-name" style="font-size:13px;">วันนี้</div>
                    <div class="progress-bg" style="height:20px;">
                        <div class="target-marker" style="left:80%"><div class="target-text">80%</div></div>
                        <div class="progress-fg grad-today" id="bar_total_today"></div>
                    </div>
                    <div class="bar-percent text-green" style="font-size:18px;"><span id="txt_total_today">0</span>%</div>
                </div>
                <div class="bar-item">
                    <div class="bar-name" style="font-size:13px;">เดือนนี้</div>
                    <div class="progress-bg" style="height:20px;">
                        <div class="target-marker" style="left:80%"></div>
                        <div class="progress-fg grad-month" id="bar_total_accum"></div>
                    </div>
                    <div class="bar-percent text-blue" style="font-size:18px;"><span id="txt_total_accum">0</span>%</div>
                </div>
                <div class="bar-item" style="margin-bottom:0;">
                    <div class="bar-name" style="font-size:13px;">ปีงบนี้</div>
                    <div class="progress-bg" style="height:20px;">
                        <div class="target-marker" style="left:80%"></div>
                        <div class="progress-fg grad-year" id="bar_total_fiscal"></div>
                    </div>
                    <div class="bar-percent" style="font-size:18px; color:#9333ea;"><span id="txt_total_fiscal">0</span>%</div>
                </div>
             </div>
        </div>

        <!-- Row 3: Rights & Services (2 Columns) -->
        <div class="grid-cols-2">
          
          <!-- Left: Rights Table -->
          <div class="card-panel accent-orange">
             <div class="card-header" style="border-bottom: none;">
                <div class="icon-wrapper bg-icon-red">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                </div>
                <div>
                   <div class="card-label">ผู้ป่วยนอกแยกตามสิทธิ</div>
                   <div class="card-desc">ไม่รวมสิทธิ UC ในเขต</div>
                </div>
             </div>
             
             <div style="padding: 10px 24px 24px 24px; overflow-x:auto;">
                <table class="table-clean">
                    <thead>
                        <tr>
                            <th style="padding-left:12px; text-align:left;">สิทธิการรักษา</th>
                            <th class="td-center">วันนี้</th>
                            <th class="td-center">เดือนนี้</th>
                            <th class="td-center">ปีที่แล้ว</th>
                            <th class="td-center" style="padding-right:12px;">+/-</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding-left:12px; text-align:left;">เบิกได้</td>
                            <td class="td-center td-num count-up" id="ofc_today">0</td>
                            <td class="td-center td-num count-up" id="ofc_month">0</td>
                            <td class="td-center"><div class="td-num" style="font-weight:600;" id="ofc_year">0</div></td>
                            <td class="td-center" style="padding-right:12px;" id="diff_ofc">-</td>
                        </tr>
                        <tr>
                            <td style="padding-left:12px; text-align:left;">เบิกได้ อปท.</td>
                            <td class="td-center td-num count-up" id="lgo_today">0</td>
                            <td class="td-center td-num count-up" id="lgo_month">0</td>
                            <td class="td-center"><div class="td-num" style="font-weight:600;" id="lgo_year">0</div></td>
                            <td class="td-center" style="padding-right:12px;" id="diff_lgo">-</td>
                        </tr>
                         <tr>
                            <td style="padding-left:12px; text-align:left;">รูด EDC</td>
                            <td class="td-center td-num count-up" id="edc_today">0</td>
                            <td class="td-center td-num count-up" id="edc_month">0</td>
                            <td class="td-center"><div class="td-num" style="font-weight:600;" id="edc_year">0</div></td>
                            <td class="td-center" style="padding-right:12px;" id="diff_edc">-</td>
                        </tr>
                        <tr>
                            <td style="padding-left:12px; text-align:left;">ประกันสังคม</td>
                            <td class="td-center td-num count-up" id="sss_today">0</td>
                            <td class="td-center td-num count-up" id="sss_month">0</td>
                            <td class="td-center"><div class="td-num" style="font-weight:600;" id="sss_year">0</div></td>
                            <td class="td-center" style="padding-right:12px;" id="diff_sss">-</td>
                        </tr>
                        <tr>
                            <td style="padding-left:12px; text-align:left;">UC นอกเขต</td>
                            <td class="td-center td-num count-up" id="uc_today">0</td>
                            <td class="td-center td-num count-up" id="uc_month">0</td>
                            <td class="td-center"><div class="td-num" style="font-weight:600;" id="uc_year">0</div></td>
                            <td class="td-center" style="padding-right:12px;" id="diff_uc">-</td>
                        </tr>
                         <tr>
                            <td style="padding-left:12px; text-align:left;">ใบรับรองแพทย์ชำระเงินเอง</td>
                            <td class="td-center td-num count-up" id="cer_today">0</td>
                            <td class="td-center td-num count-up" id="cer_month">0</td>
                            <td class="td-center"><div class="td-num" style="font-weight:600;" id="cer_year">0</div></td>
                            <td class="td-center" style="padding-right:12px;" id="diff_cer">-</td>
                        </tr>
                        <tr>
                            <td style="padding-left:12px; text-align:left;">ชำระเงินเอง</td>
                            <td class="td-center td-num count-up" id="cast_today">0</td>
                            <td class="td-center td-num count-up" id="cast_month">0</td>
                            <td class="td-center"><div class="td-num" style="font-weight:600;" id="cast_year">0</div></td>
                            <td class="td-center" style="padding-right:12px;" id="diff_cast">-</td>
                        </tr>
                        <tr class="row-total">
                            <td style="padding-left:12px; text-align:left;">รวมทั้งหมด</td>
                            <td class="td-center td-total count-up" id="total_rights_today">0</td>
                            <td class="td-center td-total count-up" id="total_rights_month">0</td>
                            <td class="td-center"><div class="td-total" style="color:#333;" id="total_rights_year">0</div></td>
                            <td class="td-center" style="padding-right:12px;" id="diff_total">-</td>
                        </tr>
                    </tbody>
                </table>
             </div>
          </div>

          <!-- Right: Services List -->
          <div class="card-panel accent-orange">
             <div class="card-header" style="border-bottom: none;">
                <div class="icon-wrapper bg-icon-orange">
                    <!-- Medical Kit Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M19 7h-3V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                      <path d="M9 14h6"/>
                      <path d="M12 11v6"/>
                    </svg>
                </div>
                <div>
                    <div class="card-label">ผู้ป่วยนอกแยกตามบริการ</div>
                    <div class="card-desc">รวม <span id="service_total_sum">0</span> ราย</div>
                </div>
             </div>
             
             <div class="card-body">
                <div class="service-list-item">
                    <div style="display:flex; align-items:center;">
                        <div class="svc-icon">
                            <!-- PT Icon: Wheelchair -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="9" cy="5.5" r="2.5"/>
                                <path d="M15 19l-2-6-3-1h-2v4h2"/>
                                <path d="M9.5 20a5.5 5.5 0 1 1 5.5-5.5V15"/>
                            </svg>
                        </div>
                        <div>
                            <div style="font-weight:700; font-size:16px;">กายภาพบำบัด</div>
                            <div style="font-size:12px; color:#6b7280;" id="service_pt_desc">-</div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="svc-val count-up" id="service_pt_total">0</div>
                        <div style="font-size:12px; color:#6b7280;">ราย</div>
                    </div>
                </div>

                <div class="service-list-item">
                    <div style="display:flex; align-items:center;">
                        <div class="svc-icon" style="background:#d1fae5; color:#059669;">
                            <!-- Thai Med Icon: Sprout (Herbal) -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M7 20h10" />
                              <path d="M10 20c5.5-2.5.8-6.4 3-10" />
                              <path d="M9.5 9.4c1.1.8 1.8 2.2 2.3 3.7-2 .4-3.5.4-4.8-.3-1.2-.6-2.3-1.9-3-4.2 2.8-.5 4.4 0 5.5.8z" />
                              <path d="M14.1 6a7 7 0 0 0-1.1 4c1.9-.1 3.3-.6 4.3-1.4 1-1 1.6-2.3 1.7-4.6-2.7.1-4 1-4.9 2z" />
                            </svg>
                        </div>
                        <div>
                            <div style="font-weight:700; font-size:16px;">แพทย์แผนไทย</div>
                            <div style="font-size:12px; color:#6b7280;" id="service_thai_desc">-</div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="svc-val count-up" id="service_thai_total">0</div>
                        <div style="font-size:12px; color:#6b7280;">ราย</div>
                    </div>
                </div>

                <div class="service-list-item" style="margin-bottom:0;">
                    <div style="display:flex; align-items:center;">
                        <div class="svc-icon" style="background:#ede9fe; color:#7c3aed;">
                            <!-- Dental Icon: Laugh (Teeth) -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M18 13a6 6 0 0 1-6 5 6 6 0 0 1-6-5h12Z"/>
                                <line x1="9" x2="9.01" y1="9" y2="9"/>
                                <line x1="15" x2="15.01" y1="9" y2="9"/>
                            </svg>
                        </div>
                        <div>
                            <div style="font-weight:700; font-size:16px;">ทันตกรรม</div>
                            <div style="font-size:12px; color:#6b7280;" id="service_dental_desc">-</div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="svc-val count-up" id="service_dental_total">0</div>
                        <div style="font-size:12px; color:#6b7280;">ราย</div>
                    </div>
                </div>
             </div>
          </div>

        </div>

      </div>

      <div class="footer-section">
        <div>&copy; <span id="year">2025</span> งานเวชระเบียนและสถิติ โรงพยาบาลกุสุมาลย์</div>
      </div>
    </div>

    <!-- Scripts (Same Logic) -->
    <script>
      const INITIAL_DATA = {
        report_date: "กำลังโหลด...",
        ward_general_today: 0, ward_pakwan_today: 0, ward_general_total: 0, 
        ward_general_bed_current: 0, ward_general_bed_max: 100, ward_general_bed_today: 0,
        ward_general_bed_fiscalyear: 0, ward_general_bed_max_fiscalyear: 100,
        ward_special_today: 0, ward_special_total: 0, 
        ward_special_bed_current: 0, ward_special_bed_max: 100, ward_special_bed_today: 0,
        ward_special_bed_fiscalyear: 0, ward_special_bed_max_fiscalyear: 100,
        sum_ward_bed_current: 0, sum_ward_bed_max: 100, sum_ward_bed_today: 0,
        sum_ward_bed_fiscalyear: 0, sum_ward_bed_max_fiscalyear: 100,
        
        // Rights Data
        ofc_today: 0, ofc_month: 0, ofc_year: 0,
        lgo_today: 0, lgo_month: 0, lgo_year: 0,
        edc_today: 0, edc_month: 0, edc_year: 0,
        sss_today: 0, sss_month: 0, sss_year: 0,
        uc_today: 0, uc_month: 0, uc_year: 0,
        cer_today: 0, cer_month: 0, cer_year: 0,
        cast_today: 0, cast_month: 0, cast_year: 0,
        
        service_pt_total: 0, service_pt_desc: "-",
        service_thai_total: 0, service_thai_desc: "-",
        service_dental_total: 0, service_dental_desc: "-",
      };

      const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vR7DyM-fjpAo5aqi-MKqngTkZsHMMtzkaH11PoS8S29FNvea62BeM2qcYdpkOAFUGNV-bMT1tCT3CfU/pub?gid=0&single=true&output=csv`;
      const WARD_GENERAL_TARGET = 360;
      const WARD_SPECIAL_TARGET = 60;
      const BED_GENERAL_MAX = 36;
      const BED_SPECIAL_MAX = 6;
      const BED_TOTAL_MAX = 42;

      document.getElementById('year').textContent = new Date().getFullYear() + 543;

      function updateComparison(lastId, diffId, current, last, isTotal = false) {
        const lastEl = document.getElementById(lastId);
        const diffEl = document.getElementById(diffId);
        
        const lastVal = Number(last) || 0;
        const currentVal = Number(current) || 0;

        lastEl.textContent = lastVal.toLocaleString();

        if (lastVal === 0) {
            diffEl.innerHTML = `<span class="badge-change badge-neu">N/A</span>`;
        } else {
            const diff = currentVal - lastVal;
            const pct = (diff / lastVal) * 100;
            const sign = pct > 0 ? "+" : "";
            const cls = pct > 0 ? "badge-pos" : (pct < 0 ? "badge-neg" : "badge-neu");
            
            const sizeStyle = isTotal ? "font-size:16px; padding:6px 14px;" : "";
            diffEl.innerHTML = `<span class="badge-change ${cls}" style="${sizeStyle}">${sign}${pct.toFixed(1)}%</span>`;
        }
      }

      function animateValue(id, start, end, duration) {
        if (start === end) return;
        const obj = document.getElementById(id);
        if (!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          const ease = 1 - Math.pow(2, -10 * progress);
          const val = Math.floor(start + (end - start) * ease);
          obj.innerHTML = val.toLocaleString();
          if (progress < 1) {
            window.requestAnimationFrame(step);
          } else {
            obj.innerHTML = end.toLocaleString();
          }
        };
        window.requestAnimationFrame(step);
      }

      function renderDashboard(data) {
        document.getElementById('report_date').textContent = "ข้อมูล ณ วันที่ " + data.report_date;
        ['service_pt_desc', 'service_thai_desc', 'service_dental_desc'].forEach(k => {
          document.getElementById(k).textContent = data[k];
        });

        const numFields = [
          'ward_general_today', 'ward_pakwan_today', 'ward_general_total',
          'ward_special_today', 'ward_special_total',
          'service_pt_total', 'service_thai_total', 'service_dental_total',
          'ofc_today', 'ofc_month', 'ofc_year',
          'lgo_today', 'lgo_month', 'lgo_year',
          'edc_today', 'edc_month', 'edc_year',
          'sss_today', 'sss_month', 'sss_year',
          'uc_today', 'uc_month', 'uc_year',
          'cer_today', 'cer_month', 'cer_year',
          'cast_today', 'cast_month', 'cast_year'
        ];
        
        numFields.forEach(id => {
          const el = document.getElementById(id);
          const current = parseInt(el.textContent.replace(/,/g, '')) || 0;
          const target = parseInt(data[id]) || 0;
          animateValue(id, current, target, 1000);
        });

        // Sum Totals for Rights
        const totalRightsToday = Number(data.ofc_today) + Number(data.lgo_today) + Number(data.edc_today) + Number(data.sss_today) + Number(data.uc_today) + Number(data.cer_today) + Number(data.cast_today);
        const totalRightsMonth = Number(data.ofc_month) + Number(data.lgo_month) + Number(data.edc_month) + Number(data.sss_month) + Number(data.uc_month) + Number(data.cer_month) + Number(data.cast_month);
        const totalRightsYear = Number(data.ofc_year) + Number(data.lgo_year) + Number(data.edc_year) + Number(data.sss_year) + Number(data.uc_year) + Number(data.cer_year) + Number(data.cast_year);

        const elTotalToday = document.getElementById('total_rights_today');
        animateValue('total_rights_today', parseInt(elTotalToday.textContent.replace(/,/g, ''))||0, totalRightsToday, 1000);
        
        const elTotalMonth = document.getElementById('total_rights_month');
        animateValue('total_rights_month', parseInt(elTotalMonth.textContent.replace(/,/g, ''))||0, totalRightsMonth, 1000);
        
        // Comparisons
        updateComparison('ofc_year', 'diff_ofc', data.ofc_month, data.ofc_year);
        updateComparison('lgo_year', 'diff_lgo', data.lgo_month, data.lgo_year);
        updateComparison('edc_year', 'diff_edc', data.edc_month, data.edc_year);
        updateComparison('sss_year', 'diff_sss', data.sss_month, data.sss_year);
        updateComparison('uc_year', 'diff_uc', data.uc_month, data.uc_year);
        updateComparison('cer_year', 'diff_cer', data.cer_month, data.cer_year);
        updateComparison('cast_year', 'diff_cast', data.cast_month, data.cast_year);
        
        updateComparison('total_rights_year', 'diff_total', totalRightsMonth, totalRightsYear, true);

        // Calculate and animate Service Total
        const totalServiceToday = Number(data.service_pt_total) + Number(data.service_thai_total) + Number(data.service_dental_total);
        const elServiceTotal = document.getElementById('service_total_sum');
        // Parse current content, removing commas
        const currentServiceTotal = parseInt(elServiceTotal.textContent.replace(/,/g, '')) || 0;
        animateValue('service_total_sum', currentServiceTotal, totalServiceToday, 1000);

        const genPct = (data.ward_general_total / WARD_GENERAL_TARGET) * 100;
        document.getElementById('ward_general_percent').textContent = genPct.toFixed(2);
        
        const specPct = (data.ward_special_total / WARD_SPECIAL_TARGET) * 100;
        document.getElementById('ward_special_percent').textContent = specPct.toFixed(2);

        const updateBar = (barId, txtId, pctValue) => {
          let pct = pctValue;
          if (isNaN(pct) || !isFinite(pct)) pct = 0;
          const displayPct = Math.min(Math.max(pct, 0), 100);
          document.getElementById(barId).style.width = `${displayPct}%`;
          document.getElementById(txtId).textContent = pct.toFixed(1);
        };

        updateBar('bar_gen_today', 'txt_gen_today', (data.ward_general_bed_today * 100) / 36);
        updateBar('bar_gen_accum', 'txt_gen_accum', (data.ward_general_bed_current * 100) / data.ward_general_bed_max);
        updateBar('bar_gen_fiscal', 'txt_gen_fiscal', (data.ward_general_bed_fiscalyear * 100) / data.ward_general_bed_max_fiscalyear);
        
        updateBar('bar_spec_today', 'txt_spec_today', (data.ward_special_bed_today * 100) / 6);
        updateBar('bar_spec_accum', 'txt_spec_accum', (data.ward_special_bed_current * 100) / data.ward_special_bed_max);
        updateBar('bar_spec_fiscal', 'txt_spec_fiscal', (data.ward_special_bed_fiscalyear * 100) / data.ward_special_bed_max_fiscalyear);
        
        updateBar('bar_total_today', 'txt_total_today', (data.sum_ward_bed_today * 100) / 42);
        updateBar('bar_total_accum', 'txt_total_accum', (data.sum_ward_bed_current * 100) / data.sum_ward_bed_max);
        updateBar('bar_total_fiscal', 'txt_total_fiscal', (data.sum_ward_bed_fiscalyear * 100) / data.sum_ward_bed_max_fiscalyear);
      }

      async function fetchData(isAuto) {
        const btn = document.getElementById('refresh_btn');
        const errBox = document.getElementById('error_box');
        
        if(!isAuto) {
          btn.querySelector('svg').classList.add('spin');
          errBox.style.display = 'none';
        }

        const proxies = [
          `https://corsproxy.io/?${encodeURIComponent(GOOGLE_SHEET_URL)}`,
          `https://api.allorigins.win/raw?url=${encodeURIComponent(GOOGLE_SHEET_URL)}`
        ];

        let success = false;
        let newData = { ...INITIAL_DATA };

        for (const url of proxies) {
          try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 3000); 
            const response = await fetch(`${url}&t=${Date.now()}`, { signal: controller.signal });
            clearTimeout(id);
            
            if (!response.ok) continue;
            const text = await response.text();
            if (text.startsWith("<")) continue;

            const rows = text.split('\n').map(r => r.split(','));
            rows.forEach(r => {
              if (r.length >= 2) {
                const key = r[0]?.trim();
                const val = r[1]?.trim().replace(/['"]+/g, '');
                if (key && newData.hasOwnProperty(key)) {
                  // Ensure commas are removed before storing
                  const numValue = val.replace(/,/g, '');
                  newData[key] = isNaN(Number(numValue)) ? val : Number(numValue);
                }
                if(['report_date', 'service_pt_desc', 'service_thai_desc', 'service_dental_desc'].includes(key)) {
                   newData[key] = r[1]?.trim().replace(/['"]+/g, '');
                }
              }
            });
            
            if (newData.ward_general_bed_max === 0) newData.ward_general_bed_max = 1;
            if (newData.ward_general_bed_max_fiscalyear === 0) newData.ward_general_bed_max_fiscalyear = 1;
            if (newData.ward_special_bed_max === 0) newData.ward_special_bed_max = 1;
            if (newData.ward_special_bed_max_fiscalyear === 0) newData.ward_special_bed_max_fiscalyear = 1;
            if (newData.sum_ward_bed_max === 0) newData.sum_ward_bed_max = 1;
            if (newData.sum_ward_bed_max_fiscalyear === 0) newData.sum_ward_bed_max_fiscalyear = 1;

            success = true;
            break;
          } catch (e) { console.log(e); }
        }

        if (success) {
          localStorage.setItem('ksm_dashboard_native', JSON.stringify(newData));
          renderDashboard(newData);
        } else if (!isAuto) {
          errBox.textContent = "โหลดข้อมูลไม่สำเร็จ กรุณาตรวจสอบอินเทอร์เน็ต";
          errBox.style.display = 'block';
        }

        if(!isAuto) btn.querySelector('svg').classList.remove('spin');
      }

      document.addEventListener('DOMContentLoaded', () => {
        const cached = localStorage.getItem('ksm_dashboard_native');
        if (cached) {
          renderDashboard(JSON.parse(cached));
        }
        fetchData(true);
        setInterval(() => fetchData(true), 30000);
      });
    </script>
  </body>
</html>
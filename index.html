<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>รายงานบริการกลุ่มเป้าหมายเร่งรัด โรงพยาบาลกุสุมาลย์ จังหวัดสกลนคร</title>
    
    <!-- Google Fonts: Kanit Only (โหลดเฉพาะฟอนต์ที่จำเป็น) -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
      /* --- CSS Variables & Reset --- */
      :root {
        --primary-gradient: linear-gradient(135deg, #009688 0%, #006064 100%);
        --bg-color: #F0F4F8;
        --text-main: #333;
        --text-muted: #64748b;
        --card-bg: #ffffff;
        --border-color: #e2e8f0;
        
        /* Colors */
        --blue-light: #eff6ff; --blue-text: #2563eb; --blue-border: #3b82f6;
        --green-light: #ecfdf5; --green-text: #059669; --green-border: #10b981;
        --red-text: #b91c1c;
        --amber-icon: #f59e0b; --amber-bg: #fef3c7;
      }

      * { box-sizing: border-box; }
      body { 
        font-family: 'Kanit', sans-serif; 
        background-color: var(--bg-color); 
        margin: 0; padding: 10px;
        color: var(--text-main);
        line-height: 1.5;
      }

      @media (min-width: 640px) { body { padding: 20px; } }

      /* --- Layout Utilities --- */
      .container { 
        width: 100%; max-width: 1200px; margin: 0 auto; 
        display: flex; flex-direction: column; gap: 20px; 
      }
      
      .grid-responsive {
        display: grid; grid-template-columns: 1fr; gap: 16px;
      }
      @media (min-width: 768px) { .grid-responsive { grid-template-columns: 1fr 1fr; } }

      .flex { display: flex; }
      .flex-col { flex-direction: column; }
      .items-center { align-items: center; }
      .justify-between { justify-content: space-between; }
      .text-center { text-align: center; }
      .text-right { text-align: right; }
      .mb-2 { margin-bottom: 8px; }
      .mb-4 { margin-bottom: 16px; }
      .mt-2 { margin-top: 8px; }
      .gap-2 { gap: 8px; }
      .gap-4 { gap: 16px; }

      /* --- Components --- */
      .card {
        background: var(--card-bg);
        border-radius: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid var(--border-color);
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      /* Header */
      .header-section {
        background: var(--primary-gradient);
        color: white;
        padding: 30px 20px;
        border-radius: 24px;
      }
      .header-title { font-size: 20px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 0; line-height: 1.3; }
      .header-subtitle { font-size: 18px; font-weight: 700; margin-top: 8px; opacity: 0.95; }
      @media (min-width: 768px) {
        .header-title { font-size: 28px; }
        .header-subtitle { font-size: 24px; }
      }

      .date-badge {
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255,255,255,0.2);
        padding: 6px 16px;
        border-radius: 50px;
        font-size: 16px; font-weight: 300;
        display: inline-flex; align-items: center; gap: 8px;
        margin-top: 12px;
      }

      .refresh-btn {
        background: transparent; border: none; color: rgba(255,255,255,0.8); 
        cursor: pointer; padding: 0; display: flex; transition: transform 0.3s;
      }
      .refresh-btn:hover { color: white; transform: rotate(180deg); }
      .spin { animation: spin 1s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }

      /* Ward Styling */
      .ward-card { padding: 20px; border-left: 6px solid transparent; height: 100%; display: flex; flex-direction: column; }
      .ward-blue { border-left-color: var(--blue-border); }
      .ward-green { border-left-color: var(--green-border); }

      .icon-circle {
        width: 48px; height: 48px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        margin-right: 12px; flex-shrink: 0;
      }
      .icon-circle.sm { width: 32px; height: 32px; margin-right: 10px; }
      
      .bg-blue-light { background-color: var(--blue-light); color: var(--blue-text); }
      .bg-green-light { background-color: var(--green-light); color: var(--green-text); }
      .bg-rose-light { background-color: #ffe4e6; color: #e11d48; }
      .bg-amber-light { background-color: var(--amber-bg); color: #d97706; }

      .stat-box {
        background: #f8fafc; border: 1px solid var(--border-color);
        border-radius: 12px; padding: 12px; text-align: center;
      }
      .stat-val { font-size: 36px; font-weight: 700; color: #333; line-height: 1; }
      .stat-val-red { font-size: 28px; font-weight: 700; color: var(--red-text); line-height: 1; }
      @media (min-width: 768px) { 
        .stat-val { font-size: 56px; } 
        .stat-val-red { font-size: 42px; }
      }
      .stat-label { font-size: 12px; color: var(--text-muted); font-weight: 500; margin-bottom: 4px; }

      /* Progress Bars */
      .occupancy-card { padding: 16px; background: white; }
      .progress-bar-bg {
        height: 16px; background: #f1f5f9; border-radius: 12px; overflow: hidden; position: relative;
      }
      .progress-bar-fill {
        height: 100%; border-radius: 12px; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); width: 0%;
      }
      .target-line {
        position: absolute; top: -4px; bottom: -4px; width: 2px; background-color: #b91c1c; z-index: 5;
      }
      .target-label {
        position: absolute; top: -14px; font-size: 10px; color: #b91c1c; font-weight: bold; left: 50%; transform: translateX(-50%); white-space: nowrap;
      }

      /* Table */
      .table-card { padding: 20px; }
      .table-responsive { overflow-x: auto; }
      .custom-table { width: 100%; border-collapse: collapse; min-width: 300px; }
      .custom-table th { text-align: left; padding: 12px 8px; color: var(--text-muted); font-size: 12px; border-bottom: 2px solid #f1f5f9; }
      .custom-table th.center { text-align: center; }
      .custom-table td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
      .custom-table tr:last-child td { border-bottom: none; font-weight: 700; background: #f8fafc; }
      
      /* ปรับขนาดตัวเลขในตารางให้เท่ากันตามคำขอ */
      .num-cell { text-align: center; font-weight: 700; font-size: 28px; } 
      .change-cell { text-align: center; font-weight: 600; font-size: 18px; }
      
      /* ตัวเลขแถวรวม (ใหญ่ขึ้น 1 ระดับ และเป็นสีดำสำหรับ 3 คอลัมน์แรก) */
      .num-cell-total { 
        text-align: center; font-weight: 800; font-size: 30px; color: #333; /* เปลี่ยนเป็นสีดำ */
      }
      .change-cell-total { 
        text-align: center; font-weight: 800; font-size: 30px; 
      }

      @media (min-width: 768px) {
        .custom-table th { font-size: 13px; }
        .custom-table td { font-size: 15px; }
        .num-cell { font-size: 32px; } 
        .num-cell-total, .change-cell-total { font-size: 36px; } 
      }
      .text-red { color: var(--red-text); }

      /* สีสำหรับ % Change */
      .text-red-dark { color: #b91c1c; font-weight: 700; } /* แดงเข้ม */
      .text-green-dark { color: #15803d; font-weight: 700; } /* เขียวเข้ม */
      
      /* Services */
      .service-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: 16px; border: 1px solid var(--border-color); border-radius: 16px;
        margin-bottom: 12px; cursor: pointer; transition: transform 0.2s;
      }
      .service-item:hover { transform: translateX(4px); border-color: #cbd5e1; }
      .service-icon { 
        width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        background: var(--amber-bg); color: var(--amber-icon); margin-right: 12px; flex-shrink: 0;
      }
      .service-name { font-weight: 700; font-size: 15px; color: #333; }
      .service-desc { font-size: 11px; color: var(--text-muted); }
      @media (min-width: 768px) { .service-name { font-size: 16px; } }

      /* Footer */
      .footer { text-align: center; color: var(--text-muted); font-size: 12px; padding: 10px 0 5px; font-weight: 300; }
      .error-box { background: #fef2f2; color: #b91c1c; padding: 10px; border-radius: 8px; font-size: 12px; display: none; margin-top: 10px; text-align: center; }
    </style>
  </head>
  <body>

    <div class="container">
      <!-- Header -->
      <div class="card header-section text-center">
        <h1 class="header-title">รายงานบริการกลุ่มเป้าหมายเร่งรัด</h1>
        <h2 class="header-subtitle">โรงพยาบาลกุสุมาลย์ จังหวัดสกลนคร ปีงบประมาณ พ.ศ. 2569</h2>
        <div class="date-badge">
          <span id="report_date">กำลังโหลด...</span>
          <button id="refresh_btn" class="refresh-btn" onclick="fetchData(false)">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
          </button>
        </div>
        <div id="error_box" class="error-box"></div>
      </div>

      <!-- Wards -->
      <div class="grid-responsive">
        <!-- General Ward -->
        <div class="card ward-card ward-blue">
          <div class="flex items-center mb-4">
            <div class="icon-circle bg-blue-light">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            </div>
            <div>
              <div style="font-size:18px; font-weight:700;">หอผู้ป่วยสามัญ</div>
              <div style="font-size:12px; color:var(--text-muted);">จำนวนผู้ป่วยที่เข้ารับการ Admit</div>
            </div>
          </div>
          <div class="grid-responsive" style="gap:10px;">
            <div class="stat-box">
              <div class="stat-label" style="color:var(--blue-text); margin-bottom:5px;">รายใหม่วันนี้</div>
              <!-- แยกรายใหม่เป็น 2 ส่วน -->
              <div style="display:flex; justify-content:center; align-items:baseline; gap:15px;">
                <div style="flex:1; text-align:center; border-right:1px solid #e2e8f0;">
                  <div style="font-size:12px; color:#64748b; margin-bottom:-5px;">สามัญ</div>
                  <div class="stat-val count-up" id="ward_general_today">0</div>
                  <div class="stat-label">ราย</div>
                </div>
                <div style="flex:1; text-align:center;">
                  <div style="font-size:12px; color:#64748b; margin-bottom:-5px;">ผักหวาน</div>
                  <div class="stat-val count-up" id="ward_pakwan_today">0</div>
                  <div class="stat-label">ราย</div>
                </div>
              </div>
            </div>
            <div class="stat-box">
              <div class="stat-label">สะสมเดือนนี้</div>
              <div class="stat-val-red count-up" id="ward_general_total">0</div>
              <div class="stat-label">ราย</div>
              <div style="margin-top:8px; padding-top:8px; border-top:1px solid #e2e8f0; font-size:13px; color:#64748b;">
                <div>เป้าหมาย 360 ราย</div>
                <div style="font-weight:700; color:var(--blue-text); font-size:15px;">คิดเป็น <span id="ward_general_percent">0.00</span>%</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Special Ward -->
        <div class="card ward-card ward-green">
          <div class="flex items-center mb-4">
            <div class="icon-circle bg-green-light">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></svg>
            </div>
            <div>
              <div style="font-size:18px; font-weight:700;">หอผู้ป่วยปุญโญภาส</div>
              <div style="font-size:12px; color:var(--text-muted);">จำนวนผู้ป่วยที่เข้ารับการ Admit</div>
            </div>
          </div>
          <div class="grid-responsive" style="gap:10px;">
            <div class="stat-box">
              <div class="stat-label" style="color:var(--green-text);">รายใหม่วันนี้</div>
              <div class="stat-val count-up" id="ward_special_today">0</div>
              <div class="stat-label">ราย</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">สะสมเดือนนี้</div>
              <div class="stat-val-red count-up" id="ward_special_total">0</div>
              <div class="stat-label">ราย</div>
              <div style="margin-top:8px; padding-top:8px; border-top:1px solid #e2e8f0; font-size:13px; color:#64748b;">
                <div>เป้าหมาย 60 ราย</div>
                <div style="font-weight:700; color:var(--green-text); font-size:15px;">คิดเป็น <span id="ward_special_percent">0.00</span>%</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Occupancy Double Bars -->
      <div class="grid-responsive">
        <!-- General Occupancy -->
        <div class="card occupancy-card">
          <div class="flex items-center mb-4">
            <div class="icon-circle sm bg-blue-light">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            </div>
            <div>
              <div style="font-weight:700; font-size:15px;">อัตราครองเตียงหอผู้ป่วยสามัญ</div>
              <div style="font-size:11px; color:var(--text-muted);">เตียงจริง 36 เตียง</div>
            </div>
          </div>
          <!-- Today -->
          <div class="flex items-center mb-2 gap-2">
            <div style="width:35px; font-size:12px; font-weight:bold; color:#64748b;">วันนี้</div>
            <div style="flex:1; position:relative; height:16px;">
              <div class="target-line" style="left:80%;"><div class="target-label">80%</div></div>
              <div class="progress-bar-bg"><div class="progress-bar-fill" id="bar_gen_today" style="background:linear-gradient(90deg, #6ee7b7, #34d399);"></div></div>
            </div>
            <div class="text-right" style="width:60px; font-size:20px; font-weight:bold; color:#10b981;"><span id="txt_gen_today">0.0</span>%</div>
          </div>
          <!-- Accum -->
          <div class="flex items-center gap-2">
            <div style="width:35px; font-size:12px; font-weight:bold; color:#64748b;">สะสม</div>
            <div style="flex:1; position:relative; height:16px;">
              <div class="target-line" style="left:80%;"></div>
              <div class="progress-bar-bg"><div class="progress-bar-fill" id="bar_gen_accum" style="background:linear-gradient(90deg, #93c5fd, #3b82f6);"></div></div>
            </div>
            <div class="text-right" style="width:60px; font-size:20px; font-weight:bold; color:#3b82f6;"><span id="txt_gen_accum">0.0</span>%</div>
          </div>
        </div>

        <!-- Special Occupancy -->
        <div class="card occupancy-card">
          <div class="flex items-center mb-4">
            <div class="icon-circle sm bg-green-light">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            </div>
            <div>
              <div style="font-weight:700; font-size:15px;">อัตราครองเตียงหอผู้ป่วยปุญโญภาส</div>
              <div style="font-size:11px; color:var(--text-muted);">เตียงจริง 6 เตียง</div>
            </div>
          </div>
          <!-- Today -->
          <div class="flex items-center mb-2 gap-2">
            <div style="width:35px; font-size:12px; font-weight:bold; color:#64748b;">วันนี้</div>
            <div style="flex:1; position:relative; height:16px;">
              <div class="target-line" style="left:80%;"><div class="target-label">80%</div></div>
              <div class="progress-bar-bg"><div class="progress-bar-fill" id="bar_spec_today" style="background:linear-gradient(90deg, #6ee7b7, #34d399);"></div></div>
            </div>
            <div class="text-right" style="width:60px; font-size:20px; font-weight:bold; color:#10b981;"><span id="txt_spec_today">0.0</span>%</div>
          </div>
          <!-- Accum -->
          <div class="flex items-center gap-2">
            <div style="width:35px; font-size:12px; font-weight:bold; color:#64748b;">สะสม</div>
            <div style="flex:1; position:relative; height:16px;">
              <div class="target-line" style="left:80%;"></div>
              <div class="progress-bar-bg"><div class="progress-bar-fill" id="bar_spec_accum" style="background:linear-gradient(90deg, #93c5fd, #3b82f6);"></div></div>
            </div>
            <div class="text-right" style="width:60px; font-size:20px; font-weight:bold; color:#3b82f6;"><span id="txt_spec_accum">0.0</span>%</div>
          </div>
        </div>
      </div>

      <!-- Total Occupancy -->
      <div class="card occupancy-card">
        <div class="flex items-center mb-4">
          <div class="icon-circle sm bg-blue-light">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
          </div>
          <div>
            <div style="font-weight:700; font-size:16px;">อัตราครองเตียงรวม</div>
            <div style="font-size:12px; color:var(--text-muted);">เตียงรวม 42 เตียง</div>
          </div>
        </div>
        <!-- Today -->
        <div class="flex items-center mb-2 gap-2">
          <div style="width:35px; font-size:12px; font-weight:bold; color:#64748b;">วันนี้</div>
          <div style="flex:1; position:relative; height:20px;">
            <div class="target-line" style="left:80%; top:-4px; bottom:-4px;"><div class="target-label" style="top:-14px;">80%</div></div>
            <div class="progress-bar-bg" style="height:20px;"><div class="progress-bar-fill" id="bar_total_today" style="background:linear-gradient(90deg, #6ee7b7, #34d399);"></div></div>
          </div>
          <div class="text-right" style="width:60px; font-size:20px; font-weight:bold; color:#10b981;"><span id="txt_total_today">0.0</span>%</div>
        </div>
        <!-- Accum -->
        <div class="flex items-center gap-2">
          <div style="width:35px; font-size:12px; font-weight:bold; color:#64748b;">สะสม</div>
          <div style="flex:1; position:relative; height:20px;">
            <div class="target-line" style="left:80%; top:-4px; bottom:-4px;"></div>
            <div class="progress-bar-bg" style="height:20px;"><div class="progress-bar-fill" id="bar_total_accum" style="background:linear-gradient(90deg, #93c5fd, #3b82f6);"></div></div>
          </div>
          <div class="text-right" style="width:60px; font-size:20px; font-weight:bold; color:#3b82f6;"><span id="txt_total_accum">0.0</span>%</div>
        </div>
      </div>

      <!-- Rights & Services -->
      <div class="grid-responsive">
        <!-- Rights Table -->
        <div class="card table-card">
          <div class="flex items-center mb-2">
            <div class="icon-circle sm bg-rose-light">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </div>
            <div>
              <div style="font-weight:700; font-size:16px;">จำนวนผู้ป่วยเข้ารับบริการแยกตามสิทธิ</div>
              <div style="font-size:11px; color:var(--text-muted);">(ไม่รวมสิทธิ UC ในเขต)</div>
            </div>
          </div>
          <div class="table-responsive">
            <table class="custom-table">
              <thead><tr><th>สิทธิการรักษา</th><th class="center">วันนี้</th><th class="center">เดือนนี้</th><th class="center">เดือนที่แล้ว</th><th class="center">+/-</th></tr></thead>
              <tbody>
                <tr>
                    <td>เบิกได้</td>
                    <td class="num-cell count-up" id="right_gold_today">0</td>
                    <td class="num-cell count-up" id="right_gold_total">0</td>
                    <td class="num-cell" id="last_gold">0</td>
                    <td class="change-cell" id="diff_gold">-</td>
                </tr>
                <tr>
                    <td>ประกันสังคม</td>
                    <td class="num-cell count-up" id="right_sso_today">0</td>
                    <td class="num-cell count-up" id="right_sso_total">0</td>
                    <td class="num-cell" id="last_sso">0</td>
                    <td class="change-cell" id="diff_sso">-</td>
                </tr>
                <tr>
                    <td>UC นอกเขต</td>
                    <td class="num-cell count-up" id="right_uc_today">0</td>
                    <td class="num-cell count-up" id="right_uc_total">0</td>
                    <td class="num-cell" id="last_uc">0</td>
                    <td class="change-cell" id="diff_uc">-</td>
                </tr>
                <tr>
                    <td>ชำระเงินเอง</td>
                    <td class="num-cell count-up" id="right_cash_today">0</td>
                    <td class="num-cell count-up" id="right_cash_total">0</td>
                    <td class="num-cell" id="last_cash">0</td>
                    <td class="change-cell" id="diff_cash">-</td>
                </tr>
                <tr>
                    <td>รวมทั้งหมด</td>
                    <td class="num-cell-total count-up" id="total_rights_today">0</td>
                    <td class="num-cell-total count-up" id="total_rights_total">0</td>
                    <td class="num-cell-total" id="last_total">0</td>
                    <td class="change-cell-total" id="diff_total">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Services -->
        <div class="card table-card" style="display:flex; flex-direction:column;">
          <div class="flex items-center mb-4">
            <div class="icon-circle sm bg-amber-light">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            </div>
            <div style="font-weight:700; font-size:16px;">ข้อมูลผู้ป่วยแยกตามบริการ</div>
          </div>
          
          <div class="service-item">
            <div class="flex items-center">
              <div class="service-icon" style="background:#ffedd5; color:#ea580c;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1" /><path d="m9 20 3-6 3 6" /><path d="m6 8 6 2 6-2" /><path d="M12 10v4" /></svg>
              </div>
              <div><div class="service-name">กายภาพบำบัด</div><div class="service-desc" id="service_pt_desc">-</div></div>
            </div>
            <div class="text-right"><div class="stat-val-red" style="font-size:26px;" id="service_pt_total">0</div><div class="stat-label">ราย</div></div>
          </div>

          <div class="service-item">
            <div class="flex items-center">
              <div class="service-icon" style="background:#ccfbf1; color:#0d9488;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 20h10" /><path d="M10 20c5.5-2.5.8-6.4 3-10" /><path d="M9.5 9.4c1.1.8 1.8 2.2 2.3 3.7-2 .4-3.5.4-4.8-.3-1.2-.6-2.3-1.9-3-4.2 2.8-.5 4.4 0 5.5.8z" /><path d="M14.1 6a7 7 0 0 0-1.1 4c1.9-.1 3.3-.6 4.3-1.4 1-1 1.6-2.3 1.7-4.6-2.7.1-4 1-4.9 2z" /></svg>
              </div>
              <div><div class="service-name">แพทย์แผนไทย</div><div class="service-desc" id="service_thai_desc">-</div></div>
            </div>
            <div class="text-right"><div class="stat-val-red" style="font-size:26px;" id="service_thai_total">0</div><div class="stat-label">ราย</div></div>
          </div>

          <div class="service-item">
            <div class="flex items-center">
              <div class="service-icon" style="background:#f3e8ff; color:#9333ea;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>
              </div>
              <div><div class="service-name">ทันตกรรม</div><div class="service-desc" id="service_dental_desc">-</div></div>
            </div>
            <div class="text-right"><div class="stat-val-red" style="font-size:26px;" id="service_dental_total">0</div><div class="stat-label">ราย</div></div>
          </div>
        </div>
      </div>

      <div class="footer">
        <div>&copy; <span id="year">2025</span> งานเวชระเบียนและสถิติ โรงพยาบาลกุสุมาลย์</div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      // Initial Data Structure
      const INITIAL_DATA = {
        report_date: "กำลังโหลด...",
        ward_general_today: 0, ward_pakwan_today: 0, ward_general_total: 0, 
        ward_general_bed_current: 0, ward_general_bed_max: 100, ward_general_bed_today: 0,
        ward_special_today: 0, ward_special_total: 0, 
        ward_special_bed_current: 0, ward_special_bed_max: 100, ward_special_bed_today: 0,
        sum_ward_bed_current: 0, sum_ward_bed_max: 100, sum_ward_bed_today: 0,
        right_gold_today: 0, right_gold_total: 0, right_gold_total_lastmonth: 0,
        right_sso_today: 0, right_sso_total: 0, right_sso_total_lastmonth: 0,
        right_uc_today: 0, right_uc_total: 0, right_uc_total_lastmonth: 0,
        right_cash_today: 0, right_cash_total: 0, right_cash_total_lastmonth: 0,
        service_pt_total: 0, service_pt_desc: "-",
        service_thai_total: 0, service_thai_desc: "-",
        service_dental_total: 0, service_dental_desc: "-",
      };

      // Constants
      const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vR7DyM-fjpAo5aqi-MKqngTkZsHMMtzkaH11PoS8S29FNvea62BeM2qcYdpkOAFUGNV-bMT1tCT3CfU/pub?gid=0&single=true&output=csv`;
      const WARD_GENERAL_TARGET = 360;
      const WARD_SPECIAL_TARGET = 60;
      const BED_GENERAL_MAX = 36;
      const BED_SPECIAL_MAX = 6;
      const BED_TOTAL_MAX = 42;

      document.getElementById('year').textContent = new Date().getFullYear() + 543;

      // Helper for updating comparison columns
      function updateComparison(lastId, diffId, current, last) {
        const lastEl = document.getElementById(lastId);
        const diffEl = document.getElementById(diffId);
        
        const lastVal = Number(last) || 0;
        const currentVal = Number(current) || 0;

        // Set Last Month Value (with commas)
        lastEl.textContent = lastVal.toLocaleString();

        // Calculate and Set % Diff
        if (lastVal === 0) {
            diffEl.textContent = "N/A";
            // Check if it's the total row to assign correct class
            if(diffId === 'diff_total') {
                diffEl.className = "change-cell-total";
            } else {
                diffEl.className = "change-cell";
            }
        } else {
            const diff = currentVal - lastVal;
            const pct = (diff / lastVal) * 100;
            const sign = pct > 0 ? "+" : "";
            const colorClass = pct > 0 ? "text-green-dark" : (pct < 0 ? "text-red-dark" : "text-gray-500");
            
            // Adjust class based on row type (normal vs total)
            const baseClass = diffId === 'diff_total' ? "change-cell-total" : "change-cell";
            
            // Render without font-size override in HTML, let CSS handle it
            diffEl.innerHTML = `${sign}${pct.toFixed(1)}%`;
            diffEl.className = `${baseClass} ${colorClass}`;
        }
      }

      // Animate Value with Commas
      function animateValue(id, start, end, duration) {
        if (start === end) return;
        const obj = document.getElementById(id);
        if (!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          const ease = 1 - Math.pow(2, -10 * progress); // EaseOutExpo
          const val = Math.floor(start + (end - start) * ease);
          obj.innerHTML = val.toLocaleString(); // Add commas
          if (progress < 1) {
            window.requestAnimationFrame(step);
          } else {
            obj.innerHTML = end.toLocaleString(); // Add commas
          }
        };
        window.requestAnimationFrame(step);
      }

      // Update UI
      function renderDashboard(data) {
        // Simple Fields
        document.getElementById('report_date').textContent = "ข้อมูล ณ วันที่ " + data.report_date;
        ['service_pt_desc', 'service_thai_desc', 'service_dental_desc'].forEach(k => {
          document.getElementById(k).textContent = data[k];
        });

        // Animated Fields
        const numFields = [
          'ward_general_today', 'ward_pakwan_today', 'ward_general_total',
          'ward_special_today', 'ward_special_total',
          'service_pt_total', 'service_thai_total', 'service_dental_total',
          'right_gold_today', 'right_gold_total',
          'right_sso_today', 'right_sso_total',
          'right_uc_today', 'right_uc_total',
          'right_cash_today', 'right_cash_total'
        ];
        
        numFields.forEach(id => {
          const el = document.getElementById(id);
          // Remove commas before parsing
          const current = parseInt(el.textContent.replace(/,/g, '')) || 0;
          const target = parseInt(data[id]) || 0;
          animateValue(id, current, target, 1000);
        });

        // Totals
        const totalRightToday = Number(data.right_gold_today) + Number(data.right_sso_today) + Number(data.right_uc_today) + Number(data.right_cash_today);
        const totalRightTotal = Number(data.right_gold_total) + Number(data.right_sso_total) + Number(data.right_uc_total) + Number(data.right_cash_total);
        
        const elTotalToday = document.getElementById('total_rights_today');
        animateValue('total_rights_today', parseInt(elTotalToday.textContent.replace(/,/g, ''))||0, totalRightToday, 1000);
        
        const elTotalTotal = document.getElementById('total_rights_total');
        animateValue('total_rights_total', parseInt(elTotalTotal.textContent.replace(/,/g, ''))||0, totalRightTotal, 1000);

        // Comparisons
        updateComparison('last_gold', 'diff_gold', data.right_gold_total, data.right_gold_total_lastmonth);
        updateComparison('last_sso', 'diff_sso', data.right_sso_total, data.right_sso_total_lastmonth);
        updateComparison('last_uc', 'diff_uc', data.right_uc_total, data.right_uc_total_lastmonth);
        updateComparison('last_cash', 'diff_cash', data.right_cash_total, data.right_cash_total_lastmonth);
        
        const totalLastMonth = Number(data.right_gold_total_lastmonth) + Number(data.right_sso_total_lastmonth) + Number(data.right_uc_total_lastmonth) + Number(data.right_cash_total_lastmonth);
        updateComparison('last_total', 'diff_total', totalRightTotal, totalLastMonth);

        // Percentages
        const genPct = (data.ward_general_total / WARD_GENERAL_TARGET) * 100;
        document.getElementById('ward_general_percent').textContent = genPct.toFixed(2);
        
        const specPct = (data.ward_special_total / WARD_SPECIAL_TARGET) * 100;
        document.getElementById('ward_special_percent').textContent = specPct.toFixed(2);

        // Bars
        const updateBar = (barId, txtId, current, max) => {
          let pct = (current / max) * 100;
          if (max === 0) pct = 0;
          pct = Math.min(Math.max(pct, 0), 100);
          document.getElementById(barId).style.width = `${pct}%`;
          document.getElementById(txtId).textContent = pct.toFixed(1);
        };

        // General Bars
        updateBar('bar_gen_today', 'txt_gen_today', data.ward_general_bed_today, BED_GENERAL_MAX);
        updateBar('bar_gen_accum', 'txt_gen_accum', data.ward_general_bed_current, data.ward_general_bed_max);

        // Special Bars
        updateBar('bar_spec_today', 'txt_spec_today', data.ward_special_bed_today, BED_SPECIAL_MAX);
        updateBar('bar_spec_accum', 'txt_spec_accum', data.ward_special_bed_current, data.ward_special_bed_max);

        // Total Bars
        updateBar('bar_total_today', 'txt_total_today', data.sum_ward_bed_today, BED_TOTAL_MAX);
        updateBar('bar_total_accum', 'txt_total_accum', data.sum_ward_bed_current, data.sum_ward_bed_max);
      }

      // Fetch Logic
      async function fetchData(isAuto) {
        const btn = document.getElementById('refresh_btn');
        const errBox = document.getElementById('error_box');
        
        if(!isAuto) {
          btn.querySelector('svg').classList.add('spin');
          errBox.style.display = 'none';
        }

        const proxies = [
          `https://corsproxy.io/?${encodeURIComponent(GOOGLE_SHEET_URL)}`,
          `https://api.allorigins.win/raw?url=${encodeURIComponent(GOOGLE_SHEET_URL)}`
        ];

        let success = false;
        let newData = { ...INITIAL_DATA };

        for (const url of proxies) {
          try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 3000); // 3s timeout
            const response = await fetch(`${url}&t=${Date.now()}`, { signal: controller.signal });
            clearTimeout(id);
            
            if (!response.ok) continue;
            const text = await response.text();
            if (text.startsWith("<")) continue;

            const rows = text.split('\n').map(r => r.split(','));
            rows.forEach(r => {
              if (r.length >= 2) {
                const key = r[0]?.trim();
                const val = r[1]?.trim().replace(/['"]+/g, '');
                if (key && newData.hasOwnProperty(key)) {
                  newData[key] = isNaN(Number(val)) ? val : Number(val);
                }
                // Handle text fields
                if(['report_date', 'service_pt_desc', 'service_thai_desc', 'service_dental_desc'].includes(key)) {
                   newData[key] = r[1]?.trim().replace(/['"]+/g, '');
                }
              }
            });
            
            // Validate Max
            if (newData.ward_general_bed_max === 0) newData.ward_general_bed_max = 1;
            if (newData.ward_special_bed_max === 0) newData.ward_special_bed_max = 1;
            if (newData.sum_ward_bed_max === 0) newData.sum_ward_bed_max = 1;

            success = true;
            break;
          } catch (e) { console.log(e); }
        }

        if (success) {
          localStorage.setItem('ksm_dashboard_native', JSON.stringify(newData));
          renderDashboard(newData);
        } else if (!isAuto) {
          errBox.textContent = "โหลดข้อมูลไม่สำเร็จ กรุณาตรวจสอบอินเทอร์เน็ต";
          errBox.style.display = 'block';
        }

        if(!isAuto) btn.querySelector('svg').classList.remove('spin');
      }

      // Init
      (() => {
        // Load cache immediately
        const cached = localStorage.getItem('ksm_dashboard_native');
        if (cached) {
          renderDashboard(JSON.parse(cached));
        }
        // Then fetch
        fetchData(true);
        // Interval
        setInterval(() => fetchData(true), 30000);
      })();
    </script>
  </body>
</html>